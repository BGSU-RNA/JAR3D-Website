{% extends "JAR3Doutput/base_result.html" %}
{% load staticfiles %}

{% block page_specific_css_class %}results-done{% endblock page_specific_css_class %}

{% block custom_css %}
  <link rel="stylesheet" href="{% static "js/fancybox/jquery.fancybox.css" %}" type="text/css" media="screen" />
  <link rel="stylesheet" href="{% static "css/tipsy.css" %}" type="text/css"/>
{% endblock custom_css %}

{% block page_subtitle %}
  {{ block.super }}
  Query {{ query_info.query_id }} completed
  <br>
  {% if query_info.group_set|length == 13%}
  Run on Motif Atlas Version {{ query_info.group_set|slice:"2:5" }}
  {% else %}
  Run on Motif Atlas Version {{ query_info.group_set|slice:"2:4" }}
  {% endif %}
{% endblock page_subtitle %}

{% block page_content %}
{{ block.super }}
<div class="row">
{% for loop,sequences,indices,mins in results %}
    <div class="span8 loop-result-container">
    <h3>
    Loop {{ forloop.counter }}
    </h3>
    Column Numbers: {{ indices }}
    <pre class="pre-scrollable loop-summary">{% for seq in sequences %}
{{seq}}<br/>
{% endfor %}</pre>
    <strong>Click on headings to reorder table</strong>
    <table class="table table-striped table-condensed table-bordered">
      <thead>
        <tr>
          <th class='table-header' data-header-name='index'>#</th>
          <th class='table-header' data-header-name='motif'>Motif ID and Additional Information</th>
          <th class='table-header' data-header-name='percent'>Acceptance Rate</th>
          <th class='table-header' data-header-name='mean-score'>Mean Cutoff Score</th>
          <th class='table-header' data-header-name='full-edit'>Full Edit Distance</th>
          <th class='table-header' data-header-name='interior-edit'>Interior Edit Distance</th>
          <th class='table-header' data-header-name='signature'>2D Diagram</th>
        </tr>
      </thead>
      <tbody>
      {% for result in loop %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td class="hover-link">
          <input type='radio' name="group" id='s{{ forloop.parentloop.counter }}-{{ forloop.counter }}'
                 class='jmolInline' data-coord='{{ result.motif_id }}'>
          <label for='s{{ forloop.parentloop.counter }}-{{ forloop.counter }}'>{{ result.motif_id }}</label>
          View <a href="{{ result.motif_url }}" target="_blank">{{ result.motif_id }}</a>

          <br>{{result.signature}}<br>

        <a href="{{result.align_url}}{{result.motif_id}}" target="_blank">Align sequences to {{ result.motif_id }}</a>
        </td>
        <td>{{ result.cutoff_percent|floatformat:2 }}</td>
        <td>{{ result.mean_cutoff_score|floatformat:2 }}</td>
        <td>{{ result.medianfulleditdist|floatformat }}</td>
        <td>{{ result.medianinterioreditdist|floatformat }}</td>
        <td>
          <a class="fancybox" rel="gallery" href="{{ result.ssurl }}"
              title="Loop {{ forloop.parentloop.counter }} - Hit {{ forloop.counter }} - Motif {{ result.motif_id }}">
              <img class="ss-thumbnail" src="{{ result.ssurl }}"></img>
          </a>
          </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    </div>
{% endfor %}
</div>

<div class="span4" id="jmol">
    <script src="{% static "jsmol/JSmol.min.js" %}"></script>
    <script type="text/javascript">
        function jmolScript(cmd) {Jmol.script(jmolApplet0, cmd)};
        function jmolScriptWait(cmd) {Jmol.scriptWait(jmolApplet0, cmd)};

        Jmol.getProfile();

        var jsMolSize = 340;

        var config = {
          width: jsMolSize,
          height: jsMolSize,
          debug: false,
          color: "#F0F0F0",
          addSelectionOptions: false,
          use: "HTML5",
          j2sPath: "{% static "jsmol/j2s" %}",
          isSigned: false,
          disableJ2SLoadMonitor: true,
          disableInitialConsole: true,
          allowjavascript: true,
          readyFunction: function() {
            $('.jmolInline').first().jmolToggle();
          },
        };
        jmolApplet0 = Jmol.getApplet("jmolApplet0", config);
    </script>

    <input type='button' id='neighborhood' class='btn' value="Show neighborhood">
    <input type='button' id='stereo' class='btn' value="Show stereo">
    <input type='button' id='prev' class='btn' value='Previous'>
    <input type='button' id='next' class='btn' value="Next">
    <label><input type="checkbox" id="showNtNums">Numbers</label>
</div>

<div id="popup-text">
  <div class="help-text" hidden data-header-name="percent">
  Percentage of input sequences which meet the criteria to match the motif.  80% or above is good.
  </div>

  <div class="help-text" hidden data-header-name="mean-score">
  A score indicating how close a sequence is to the cutoff barrier.  100 is the best, 0 is right on the cutoff line, negative is outside of the cutoff region.
  </div>

  <div class="help-text" hidden data-header-name="full-edit">
  The median of the minimum edit distance between each input sequence and sequences of each motif from 3D structures.
  </div>

  <div class="help-text" hidden data-header-name="interior-edit">
  The median of the minimum edit distance between each input sequence and sequences of each motif from 3D structures, aside from the flanking basepairs.
  </div>

  <div class="help-text" hidden data-header-name="signature">
  A 2D diagram of the consensus interactions in the motif group.
  </div>
</div>
{% endblock page_content%}

{% block page_specific_js %}
    {{ block.super }}
    <script src="{% static "js/jquery.tablesorter.min.js" %}"></script>
    <script src="{% static "js/jquery.jmolTools.js" %}"></script>
    <script src="{% static "js/fancybox/jquery.fancybox.pack.js" %}"></script>
    <script src="{% static "js/jquery.tipsy.js" %}"></script>

    <script>
      $(document).ready(function() {
          $("table").tablesorter();

          // initialize jmolTools
          $('.jmolInline').jmolTools({
              showStereoId: 'stereo',
              showNeighborhoodId: 'neighborhood',
              showNumbersId: 'showNtNums',
              showNextId: 'next',
              showPrevId: 'prev'
          });

          // position jmol
          (function(){
              var reference = $('.loop-result-container').first();
              var offset_left = reference.offset().left + reference.width();
              var offset_top  = reference.offset().top;
              $('#jmol').css('position','fixed')
                        .css('left',offset_left)
                        .css('top',offset_top);
          })();

          // fancybox integration
        $(".fancybox").fancybox({
          openEffect	: 'none',
          closeEffect	: 'none'
        });

        $(".table-header").tipsy({
            gravity: 's',
            title: function() {
              var name = $(this).data('header-name');
              return $(".help-text[data-header-name='" + name + "']").text();
            }
        });
      });
    </script>

{% endblock page_specific_js %}
